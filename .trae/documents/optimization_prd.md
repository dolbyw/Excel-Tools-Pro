# ExcelToolsPro 优化需求文档 (PRD)

## 1. 产品概述

ExcelToolsPro 是一款面向桌面的 Excel 批处理工具，专注于文件合并、拆分、格式转换与校验功能。基于 WPF + MVVM 架构，集成了日志记录、并发控制、进度监控等核心能力。

本优化项目旨在在不显著增加复杂度的前提下，提升工具的性能表现、代码质量和用户体验，重点解决大文件处理、稳定性和可维护性问题。

## 2. 核心优化目标

### 2.1 性能优化目标
- 大文件（100MB+）处理时内存占用降低 40%
- 批量小文件处理效率提升 10-20%
- UI 响应性改善，消除卡顿现象
- HTML 格式解析稳定性达到 95% 成功率

### 2.2 质量提升目标
- 消除配置丢失和文件名冲突问题
- 建立完善的单元测试覆盖
- 提升代码结构清晰度和可维护性
- 增强错误处理和恢复能力

## 3. 详细优化方案

### 3.1 性能优化模块

#### 3.1.1 低内存模式实现
**问题描述：** ClosedXML/EPPlus 整体加载大文件时内存消耗过高，易触发 GC 压力和 OOM。

**解决方案：**
- 新增配置项：LargeFileMode 开关和阈值设置（默认 50MB）
- 实现策略：低内存模式下限制并发度，采用分批读写和流式处理
- 优先级：先在 CSV/HTML 转换路径实现，再扩展到合并功能

**验收标准：**
- 处理 100MB+ 文件时峰值内存下降 ≥40%
- 完成时间不劣化超过 10%

#### 3.1.2 并发控制优化
**问题描述：** 当前并发参数固定，无法适应不同硬件环境和数据规模。

**解决方案：**
- 在 AppConfig 中增加 MaxDegreeOfParallelism、ProgressThrottleMs 配置
- UI 设置页面提供调整界面
- 低内存模式下自动收敛并发度

**验收标准：**
- 并发度可配置范围 1-16
- 小文件批处理性能随并发度线性提升

#### 3.1.3 HTML 解析引擎加固
**问题描述：** 正则表达式解析 HTML 表格存在兼容性和性能风险。

**解决方案：**
- 轻量级：正则预编译 + 超时控制（500ms）
- 增强级：可选引入 HtmlAgilityPack 作为备用解析器
- 实现降级策略：正则失败时自动切换到库解析

**验收标准：**
- 对 10 种常见 HTML 表格变体解析成功率 >95%
- 单文件解析时间 <1s，无 UI 卡顿

#### 3.1.4 I/O 性能优化
**问题描述：** 批处理场景下 I/O 操作占比高，存在优化空间。

**解决方案：**
- 全面采用异步 I/O（FileStream async + 64KB 缓冲）
- 优化临时文件策略：统一目录、DeleteOnClose、自动清理
- CSV 编码配置化（UTF-8 BOM 可选）

**验收标准：**
- 批量 1000+ 小文件转换时长减少 ≥10%
- 无残留临时文件

#### 3.1.5 预览性能优化
**问题描述：** 大量条目预览时 UI 响应缓慢。

**解决方案：**
- 实现预览分页机制（每页 500 条）
- UI 层采用虚拟化技术
- 复用进度节流参数

**验收标准：**
- 预览 2000 项时 UI 无卡顿，滚动流畅

### 3.2 代码结构改进模块

#### 3.2.1 服务职责解耦
**当前问题：** ExcelProcessingService 承担过多职责，代码耦合度高。

**重构方案：**
- 拆分为：Parser/Reader、Transformer、Storage、Reporting 四个独立服务
- ExcelProcessingService 转为编排和策略选择角色
- HTML 解析逻辑独立为 IHtmlTableParser 接口

#### 3.2.2 依赖注入优化
**改进目标：** 提升接口化程度和可测试性。

**实施方案：**
- SplitNamingService 改为依赖 INamingEngine 接口
- 核心 I/O 和计算类通过接口注入
- 便于单元测试中使用 Mock 对象

#### 3.2.3 配置管理统一
**优化内容：**
- 统一配置入口，增加版本号和迁移策略
- 实现配置原子写入和备份恢复
- 提供配置验证和默认值机制

#### 3.2.4 日志体系规范
**标准化要求：**
- 采用结构化日志格式
- 统一关键字段命名（TemplateId, FileCount, ElapsedMs）
- 取消操作降级为 Information 级别
- 增加性能计时和瓶颈定位

### 3.3 缺陷修复模块

#### 3.3.1 配置持久化安全性
**问题：** 配置文件写入非原子性，存在损坏风险。

**修复方案：**
- 实现原子写入：临时文件 + File.Replace + .bak 备份
- 增加进程内互斥锁防止并发写入
- 提供配置恢复机制

#### 3.3.2 文件名合法性检查
**问题：** 生成的文件名可能包含非法字符或触发系统保留名。

**解决方案：**
- OS 级合法性检查和字符替换
- 保留名检测和后缀规避（CON, PRN, NUL 等）
- 文件名冲突处理策略（覆盖/跳过/递增序号）

#### 3.3.3 正则表达式安全
**风险控制：**
- 所有正则增加超时限制（500ms）
- 使用 RegexOptions.Compiled 提升性能
- 分段匹配避免灾难性回溯

#### 3.3.4 资源释放完善
**改进措施：**
- 关键对象全部使用 using 声明
- 异常路径的 finally 块清理
- 文件句柄和流的及时释放

### 3.4 可维护性提升模块

#### 3.4.1 单元测试建设
**测试范围：**
- 命名引擎：模板生成和校验逻辑
- HTML 解析：典型和边缘案例覆盖
- I/O 操作：临时文件和原子写入流程
- 配置管理：序列化和恢复机制

#### 3.4.2 代码质量工具
**工具集成：**
- 启用 Nullable 引用类型
- 集成 Microsoft.NetAnalyzers
- 配置最小化规则集
- 逐步清理编译警告

#### 3.4.3 错误处理标准化
**统一模型：**
- 实现 Result<T> 返回模式
- 定义具名异常类型
- 避免魔法字符串错误消息
- 建立错误码体系

#### 3.4.4 文档和注释规范
**维护标准：**
- XML 注释与日志字段对齐
- 关键配置增加内联说明
- API 文档自动生成
- 变更日志维护

## 4. 实施计划

### 4.1 迭代 1：基础优化（1-2 周）
**优先级：高收益低成本**
- [ ] 并发/节流参数配置化
- [ ] 正则预编译与超时控制
- [ ] 配置原子写入和备份恢复
- [ ] 文件名合法性检查和冲突处理
- [ ] 资源释放异常路径梳理

### 4.2 迭代 2：性能提升（1-2 周）
**优先级：中等投入中高收益**
- [ ] I/O 异步化和缓冲优化
- [ ] 预览分页和虚拟化
- [ ] HTML 解析轻量级加固
- [ ] 日志体系规范化

### 4.3 迭代 3：架构重构（2-3 周）
**优先级：长期收益**
- [ ] 低内存模式实现
- [ ] 服务职责解耦重构
- [ ] 依赖注入接口化
- [ ] 单元测试框架建设
- [ ] 代码质量工具集成

### 4.4 迭代 4：增强功能（按需）
**优先级：可选增强**
- [ ] HTML 解析库集成
- [ ] 错误处理模型统一
- [ ] 性能监控仪表板
- [ ] 配置迁移工具

## 5. 验收指标

### 5.1 性能指标
| 指标类别 | 基线值 | 目标值 | 测试场景 |
|---------|--------|--------|----------|
| 内存占用 | 当前值 | -40% | 100MB+ 文件处理 |
| 处理速度 | 当前值 | +10% | 1000+ 小文件批处理 |
| UI 响应 | 有卡顿 | 流畅 | 2000 项预览滚动 |
| 解析成功率 | 80% | 95% | HTML 表格变体测试 |

### 5.2 质量指标
| 指标类别 | 当前状态 | 目标状态 |
|---------|----------|----------|
| 配置丢失 | 偶发 | 零发生 |
| 文件名冲突 | 用户处理 | 自动处理 |
| 单元测试覆盖率 | 0% | 60%+ |
| 代码重复度 | 未测量 | <10% |

### 5.3 稳定性指标
| 指标类别 | 目标值 |
|---------|--------|
| 内存泄漏 | 零发生 |
| 临时文件残留 | 零发生 |
| 正则超时 | 零误报 |
| 异常恢复成功率 | 90%+ |

## 6. 风险控制

### 6.1 技术风险
- **风险：** 低内存模式可能影响处理速度
- **缓解：** 提供开关选项，默认保持当前行为

- **风险：** 架构重构可能引入新缺陷
- **缓解：** 分步实施，每步都有回滚方案

### 6.2 兼容性风险
- **风险：** 新配置项可能影响现有用户
- **缓解：** 保持向后兼容，提供迁移工具

- **风险：** 依赖库更新可能带来不稳定性
- **缓解：** 锁定版本号，充分测试后再升级

### 6.3 用户体验风险
- **风险：** 界面变化可能影响用户习惯
- **缓解：** 最小化 UI 变更，提供使用指南

## 7. 成功标准

### 7.1 必达目标
- 大文件处理内存优化达标
- 配置安全性问题完全解决
- 文件名处理稳定性达标
- 基础单元测试覆盖建立

### 7.2 期望目标
- 整体性能提升 10-20%
- 代码结构清晰度显著改善
- 错误处理机制完善
- 开发效率提升

### 7.3 理想目标
- 成为同类工具性能标杆
- 代码质量达到企业级标准
- 具备良好的扩展性
- 社区认可度提升

## 8. 资源需求

### 8.1 人力资源
- 主开发：1 人 × 6-8 周
- 测试支持：0.5 人 × 4 周
- 代码审查：按需

### 8.2 技术资源
- 开发环境：Visual Studio 2022+
- 测试工具：xUnit + Moq
- 分析工具：JetBrains dotMemory（可选）
- CI/CD：GitHub Actions（可选）

### 8.3 时间资源
- 总计：6-8 周
- 里程碑检查：每 2 周一次
- 用户反馈收集：每迭代结束后

---

**文档版本：** v1.0  
**创建日期：** 2024年1月  
**负责人：** 开发团队  
**审核人：** 产品负责人  